name: CI
on: [push]

jobs:
  build-os-python:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        # need to use bash for conda activation to work
        shell: bash -el {0}
    strategy:
      max-parallel: 5
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.9", "3.11", "3.13"]
    steps:
    - uses: actions/checkout@v3
    - name: Setup conda (for testing conda functionality)
      uses: conda-incubator/setup-miniconda@v3.1.1
      with:
        miniforge-version: latest
        auto-update-conda: true
        conda-build-version: ">=25.1"
        python-version: ${{ matrix.python-version }}
        auto-activate-base: true
        condarc-file: github-condarc.yml
        use-mamba: true
    - name: show conda versions
      run: |
        conda list -n base conda
        conda list -n base mamba
    - name: Setup pixi
      uses: prefix-dev/setup-pixi@v0.9.0
      with:
        pixi-version: v0.48.2
        cache: true
        auth-host: prefix.dev
        auth-token: ${{ secrets.GITHUB_TOKEN }}
    - name: Override Python version in pixi
      run: |
        pixi add python=${{ matrix.python-version }}
    - name: Install dependencies
      run: pixi run dev-install
    - name: Run linting checks
      run: pixi run ruff
    - name: Run type checking
      if: success() || failure()
      run: pixi run mypy
    - name: Check code formatting
      # Skip on Windows due to line ending differences (CRLF vs LF)
      if: (success() || failure()) && runner.os != 'Windows'
      run: pixi run check-format
    - name: Test with pytest
      if: success() || failure()
      run: |
        pixi run external-coverage
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
